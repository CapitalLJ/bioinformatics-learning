# 目录

   * [RNA-seq分析](#rna-seq分析)
      * [0. 介绍](#0-介绍)
      * [1. 前期准备](#1-前期准备)
      * [2. 工具下载](#2-工具下载)
         * [2.0 生信管理工具](#20-生信管理工具)
         * [2.1 sratoolkit](#21-sratoolkit)
         * [2.2 fastqc](#22-fastqc)
         * [2.3 multiqc](#23-multiqc)
         * [2.4 cutadapt](#24-cutadapt)
         * [2.5 trimmomatic](#25-trimmomatic)
         * [2.6 hisat2](#26-hisat2)
         * [sortmerna](#sortmerna)
         * [2.7 samtools](#27-samtools)
         * [2.8 HTseq](#28-htseq)
         * [2.9 R](#29-r)
         * [2.10 Rstudio](#210-rstudio)
         * [2.11 parallel](#211-parallel)
         * [StringTie[可选]](#stringtie可选)
         * [Ballgown[可选]](#ballgown可选)
      * [3. 数据下载](#3-数据下载)
         * [3.1 参考数据](#31-参考数据)
            * [Ensembl](#ensembl)
         * [3.2 测试数据（实验数据）](#32-测试数据实验数据)
      * [4. 质量控制](#4-质量控制)
         * [4.1 质量评估](#41-质量评估)
         * [4.2 剔除接头以及测序质量差的碱基](#42-剔除接头以及测序质量差的碱基)
         * [4.4 再次去除低质量区域](#44-再次去除低质量区域)
         * [4.3 再次查看质量情况](#43-再次查看质量情况)
      * [5. 去除rRNA序列](#5-去除rrna序列)
      * [6. 序列比对](#6-序列比对)
         * [6.1 建立索引](#61-建立索引)
         * [6.2  开始比对](#62--开始比对)
      * [7. 表达量统计](#7-表达量统计)
      * [8. 合并表达矩阵与标准化](#8-合并表达矩阵与标准化)
         * [8.1 合并](#81-合并)
         * [8.2 数据标准化](#82-数据标准化)
            * [8.2.1 简介](#821-简介)
         * [8.2.2 cufflinks](#822-cufflinks)
         * [8.2.3 手动计算](#823-手动计算)
      * [9. 差异表达分析](#9-差异表达分析)
         * [9.1 数据前处理](#91-数据前处理)
         * [9.2 差异分析](#92-差异分析)
            * [9.2.1 安装与加载包](#921-安装与加载包)
            * [9.2.2 构建对象](#922-构建对象)
            * [9.2.3 样本相关性](#923-样本相关性)
            * [9.2.4 差异基因](#924-差异基因)
      * [10. 提取差异表达基因与注释](#10-提取差异表达基因与注释)
         * [10.1 名词解释](#101-名词解释)
         * [10.2 使用ClusterProfiler对基因的ID进行转化](#102-使用clusterprofiler对基因的id进行转化)
         * [10.3 使用biomaRt进行注释](#103-使用biomart进行注释)
      * [11. 可视化](#11-可视化)
      * [12. 富集分析](#12-富集分析)
         * [12.1 Gene Ontology (GO)分析](#121-gene-ontology-go分析)
         * [12.2 KEGG分析](#122-kegg分析)
         * [12.3 GSEA分析](#123-gsea分析)
         * [12.4 DO（Disease Ontology）分析](#124-dodisease-ontology分析)
         * [12.4 另外可以使用几个在线网站](#124-另外可以使用几个在线网站)
      * [========================================](#-1)
      * [5. 表达量分析](#5-表达量分析)
      * [6. 表达量分析](#6-表达量分析)
      * [7. 差异表达分析](#7-差异表达分析)
      * [作者](#作者)
      * [参考](#参考)
         * [流程](#流程)
         * [结果解读](#结果解读)
         * [原理](#原理)
         * [程序下载安装](#程序下载安装)
         * [问题](#问题)

# RNA-seq分析

## 0. 介绍
```
转录组（Transcriptome）被定义为一个细胞中存在的所有转录本读取的集合。
RNA-seq数据用于研究和/或量化一个生物体的转录组，它可用于以下类型的实验：

差异基因表达（Differential Gene Expression）: 转录本水平的定量评估和比较
转录组组装（Transcriptome assembly）: 构建基因组转录区域的轮廓，是一种定性评估
能被用于帮助建立更好的基因模型，并使用组装来验证
元转录组学或群体转录组学分析
RNA-seq 除了得到差异表达的基因之外，还可以对SNP、新颖的转录本、可变剪接、RNA编辑等进行分析，但是最为常见的是得到差异表达的基因。
```

各种软件功能简介：
```
     database                   Workflow                        tools
======================================================================================
  
+=================+     +-------------------------+                               
|     database    |     |      Quality Analysis   |---------------> fastqc 
+=================+     +-------------------------+                                
|+------+         |                 v                                      
|| rRNA |---------|--+  +-------------------------+
|+------+         |  |  | Base Quality Filtering  |------------> TrimGalore
|  +------+       |  |  +-------------------------+
|  |genome|-------|-+|              v
|  +------+       | ||  +-------------------------+
|     +----------+| |+->| rRNA Sequence Filtering |------------> SortMeRNA
|     |  Genome  || |   +-------------------------+
|     |Annotation|| |               v
|     +----------+| |   +-------------------------+
|          |      | +-->|   Genome Alignment      |------------> hisat2
+----------|------+     +-------------------------+
           |                        v
           |            +-------------------------+
           +----------->|  Count Mapped Reads     |------------> HTseq
                        +-------------------------+
                                    v
                        +-------------------------+
                        | Differential Expression |------------> DESeq2
                        +-------------------------+
                                    v
                        +-------------------------+
                        |     Pathway analysis    |------------> ClusterProfiler
                        +-------------------------+
```
各类数据分析步骤及需要用到的软件：  
* RNA-seq  
① MultiQC 整理数据，general statistics  
② featureCounts： Subread featureCounts是一个高效的通用阅读摘要程序，用于计算基因组特征（如基因，外显子，启动子，基因体，基因组箱和染色体位置）的映射读取。    
③ cutadapt： Cutadapt是一种工具，用于从高通量测序读取中查找和删除adapter序列，引物，poly-A尾部和其他类型的不需要的序列。   
④ fastQC: FastQC是高通量序列数据的质量控制工具。  
* whole-genome seq :   
① MultiQC 整理数据，general statistics  
② QualiMap： 是一个独立于平台的应用程序，用于促进比对序列数据及其衍生物（如特征计数）的质量控制。        
③ SnpEff： SnpEff是一个遗传变异注释和效果预测工具箱。它注释和预测变异对基因的影响（如氨基酸变化）。     
④ GATK: GATK是一个工具包，提供各种工具，主要关注变异发现和基因分型。  
⑤ Picard： Picard 是一组用于操作高通量测序数据的 Java 命令行工具。  
⑥ FastQ Screen ：FastQ Screen允许您根据一组序列数据库筛选FastQ格式的序列库，以便您可以查看库的组成是否与您期望的匹配。  
⑦ fastQC: FastQC是高通量序列数据的质量控制工具。   
* Bisulfite seq   
① MultiQC 整理数据，general statistics  
② Bismark ： Bismark是一种绘制亚硫酸氢盐转化序列读数和确定胞嘧啶甲基化状态的工具。  
③ cutadapt： Cutadapt是一种工具，用于从高通量测序读取中查找和删除adapter序列，引物，poly-A尾部和其他类型的不需要的序列。  
④ fastQC: FastQC是高通量序列数据的质量控制工具。  
* Hi-C  
① MultiQC 整理数据，general statistics  
② HICUP： HiCUP（Hi-C user pipeline）是一种用于对Hi-C数据进行映射和执行质量控制的工具。  
③ fastQC: FastQC是高通量序列数据的质量控制工具。   
* MultiQC  
① MultiQC 整理数据，general statistics  
② edgeR：样本相似性由通过 edgeR 归一化的基因计数生成。然后计算 log2 归一化 CPM 值之间的欧氏距离并进行聚类。  
③ MDS PLOT: 显示项目中样本之间的相关性。这些值是在 edgeR_heatmap_MDS.r 脚本中使用 edgeR 计算的。    
④ STAR: STAR是一种超快的通用RNA-seq aligner。  
⑤ cutadapt： Cutadapt是一种工具，用于从高通量测序读取中查找和删除adapter序列，引物，poly-A尾部和其他类型的不需要的序列。  
⑥ fastQC: FastQC是高通量序列数据的质量控制工具。    






## 1.前期准备
将目录建在d盘 cd /mnt/d  
建立目录    
`mkdir biosoft`   
`mkdir -p project/rat`    
`mkdir annotation genome sequence output script`  
 
结果：  
```
xuruizhi@DESKTOP-HI65AUV:/mnt/d/project/rat$ tree
.
├── annotation
├── genome
├── output
├── script
└── sequence

5 directories, 0 files
```

## 2.工具下载 
### 2.0 生信管理工具 

Linux brew  
来源[wang-q Ubuntu -](https://github.com/wang-q/ubuntu#install-linuxbrew)

### 2.1 sratoolkit   
* 使用brew安装  
```
xuruizhi@DESKTOP-HI65AUV:~$ brew install sratoolkit

HOMEBREW_BREW_GIT_REMOTE set: using https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/brew.git for Homebrew/brew Git remote.
HOMEBREW_CORE_GIT_REMOTE set: using https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/homebrew-core.git for Homebrew/core Git remote.
Running `brew update --auto-update`...
Warning: sratoolkit 3.0.0 is already installed and up-to-date.
To reinstall 3.0.0, run:
  brew reinstall sratoolkit
```
### 2.2 fastqc  
* 使用brew安装  
```
xuruizhi@DESKTOP-HI65AUV:~$ brew install fastqc
HOMEBREW_BREW_GIT_REMOTE set: using https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/brew.git for Homebrew/brew Git remote.
HOMEBREW_CORE_GIT_REMOTE set: using https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/homebrew-core.git for Homebrew/core Git remote.
Running `brew update --auto-update`...
Warning: fastqc 0.11.9_1 is already installed and up-to-date.
To reinstall 0.11.9_1, run:
  brew reinstall fastqc
```
### 2.3 multiqc 
``` 
# 使用python的安装器安装
pip install multiqc
```
```
xuruizhi@DESKTOP-HI65AUV:~$ pip install multiqc

Requirement already satisfied: multiqc in /home/linuxbrew/.linuxbrew/lib/python3.9/site-packages (1.12)
。。。
  File "/home/linuxbrew/.linuxbrew/opt/python@3.9/lib/python3.9/site-packages/pip/_internal/utils/logging.py", line 179, in emit
    self.handleError(record)
Message: '[present-rich] %s'
Arguments: (UpgradePrompt(old='22.1.2', new='22.2.2'),)
```
### 2.4 cutadapt  

pip install cutadapt 类似  
```
# Check that cutadapt is installed
xuruizhi@DESKTOP-HI65AUV:~$ cutadapt --version
4.1

# Check that FastQC is installed
xuruizhi@DESKTOP-HI65AUV:~$ fastqc -v
FastQC v0.11.9
```

### 2.5 质量修剪  
* Trim Galore
```
cd /mnt/d/biosoft
# 先挂载到d盘相应文件

wget https://github.com/FelixKrueger/TrimGalore/archive/0.6.3.tar.gz -O TrimGalore.gz

gzip -d TrimGalore.gz
```
! [作者GitHub](https://github.com/FelixKrueger/TrimGalore)已经更新至2021年7月的0.6.6版本
```
# Install Trim Galore
curl -fsSL https://github.com/FelixKrueger/TrimGalore/archive/0.6.6.tar.gz -o TrimGalore.tar.gz
tar xvzf TrimGalore.tar.gz

# Run Trim Galore
~/TrimGalore-0.6.6/trim_galore
```
结果：  
```
xuruizhi@DESKTOP-HI65AUV:/mnt/d/biosoft$ curl -fsSL https://github.com/FelixKrueger/TrimGalore/archive/0.6.6.tar.gz -o TrimGalore.tar.gz
xuruizhi@DESKTOP-HI65AUV:/mnt/d/biosoft$ ls
TrimGalore.tar.gz  Trimmomatic-0.38  Trimmomatic-0.38.zip  hisat2-2.2.1  sortmerna-2.1  sortmerna-2.1.tar.gz  wget-log
xuruizhi@DESKTOP-HI65AUV:/mnt/d/biosoft$ tar xvzf TrimGalore.tar.gz
TrimGalore-0.6.6/
TrimGalore-0.6.6/.travis.yml
TrimGalore-0.6.6/Changelog.md
。。。
```
`！师兄的办法会得到一个单独的TrimGalore文件；作者的办法会得到包括trim_galore及其license在内的一个文件夹`

* fastp  
* trimmomatic  
```
cd /mnt/d/biosoft
# 先挂载到d盘相应文件 

wget http://www.usadellab.org/cms/uploads/supplementary/Trimmomatic/Trimmomatic-0.38.zip
unzip Trimmomatic-0.38.zip

cd Trimmomatic-0.38

# 导入临时环境变量
export PATH="$(pwd):$PATH"
```
### 2.6 hisat2  

1. [hisat2官网更改](https://daehwankimlab.github.io/hisat2/)
2. 右侧download下载,直接点击下载即可，不需要回到终端再下载。下载完成后剪切到d/biosoft文件夹内解压
```
Version: HISAT2 2.2.1
Release Date: 7/24/2020

Linux_x86_64	https://cloud.biohpc.swmed.edu/index.php/s/oTtGWbWjaxsQ2Ho/download
```
3. 回到终端写入环境
```

# 导入临时环境变量
$ export PATH="~/biosoft/hisat2-2.1.0:$PATH"

# 测试是否可用
$ hisat2 -h

xuruizhi@DESKTOP-HI65AUV:/mnt/d/biosoft$  hisat2 -h
HISAT2 version 2.2.1 by Daehwan Kim (infphilo@gmail.com, www.ccb.jhu.edu/people/infphilo)
Usage:
```
### sortmerna [选做]
有时因为安全问题无法直接从网页下载，最好还是回到终端在本地下载  

```
cd /mnt/d/biosoft
# 先挂载到d盘相应文件 
# 下载软件,已经是最新版本
$ wget https://github.com/biocore/sortmerna/archive/2.1.tar.gz -O sortmerna-2.1.tar.gz

# 解压
$ tar -xzvf sortmerna-2.1.tar.gz
$ cd sortmerna-2.1

# 配置相关信息
$ ./configure --prefix=$PWD

# 编译
$ make -j 4

# 查看是否成功
$ ./sortmerna --help

# 导入到环境变量
$ export PATH="$(pwd):$PATH"
```
结果： [具体参考](https://github.com/outcastaaa/bioinformatics-learning/blob/main/RNA-seq/%E8%A7%A3%E5%8E%8B%E5%90%8E.md) 

原本数据存放在`d/biosoft/sortmerna-2.1`文件夹内，移动数据库位置之前先在d盘新建一个database/sortmerna_db/rRNA_databases存放数据

```
xuruizhi@DESKTOP-HI65AUV:/mnt/d$ mkdir database
xuruizhi@DESKTOP-HI65AUV:/mnt/d$ cd database
。。。
xuruizhi@DESKTOP-HI65AUV:/mnt/d/database/sortmerna_db$ ls
rRNA_databases
```
```
# 把数据库文件移动到能找到的地方,d盘的database文件夹内
#没搞明白
$ mv ./rRNA_databases/ /mnt/d/database/sortmerna_db/rRNA_databases

# 相关库文件
$ cd ~/database/rRNA_databases
$ sortmerna_ref_data=$(pwd)/rRNA_databases/silva-bac-16s-id90.fasta,$(pwd)/index/silva-bac-16s-db:\
$(pwd)/rRNA_databases/silva-bac-23s-id98.fasta,$(pwd)/index/silva-bac-23s-db:\
$(pwd)/rRNA_databases/silva-arc-16s-id95.fasta,$(pwd)/index/silva-arc-16s-db:\
$(pwd)/rRNA_databases/silva-arc-23s-id98.fasta,$(pwd)/index/silva-arc-23s-db:\
$(pwd)/rRNA_databases/silva-euk-18s-id95.fasta,$(pwd)/index/silva-euk-18s-db:\
$(pwd)/rRNA_databases/silva-euk-28s-id98.fasta,$(pwd)/index/silva-euk-28s-db:\
$(pwd)/rRNA_databases/rfam-5s-database-id98.fasta,$(pwd)/index/rfam-5s-db:\
$(pwd)/rRNA_databases/rfam-5.8s-database-id98.fasta,$(pwd)/index/rfam-5.8s-db

# 真核生物的rRNA不需要那么多(5s, 5.8s, 18s, 28s)
$ euk_rNRA_ref_data=$(pwd)/rRNA_databases/silva-euk-18s-id95.fasta,$(pwd)/index/silva-euk-18s-db:\
$(pwd)/rRNA_databases/silva-euk-28s-id98.fasta,$(pwd)/index/silva-euk-28s-db:\
$(pwd)/rRNA_databases/rfam-5s-database-id98.fasta,$(pwd)/index/rfam-5s-db:\
$(pwd)/rRNA_databases/rfam-5.8s-database-id98.fasta,$(pwd)/index/rfam-5.8s-db

# 建立数据库索引
$ indexdb_rna --ref $data
```

### 2.7 samtools
最新版本为1.16  
本地下载时，在配制这步出错，使用`brew install samtools`安装

### 2.8 HTseq
```
pip install -i https://pypi.tuna.tsinghua.edu.cn/simple HTseq
```

### 2.9 R
最新版本4.2.1_2  
先进入官网，用清华镜像源下载合适版本的R，再`brew install r`

```
xuruizhi@DESKTOP-HI65AUV:~$ brew install r
HOMEBREW_BREW_GIT_REMOTE set: using https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/brew.git for Homebrew/brew Git remote.
HOMEBREW_CORE_GIT_REMOTE set: using https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/homebrew-core.git for Homebrew/core Git remote.
Running `brew update --auto-update`...
Warning: r 4.2.1_2 is already installed and up-to-date.
To reinstall 4.2.1_2, run:
  brew reinstall r
  ```
* !R 安装时多次尝试，RStudio都识别不到，因此直接在官网选择`Download R for Windows; install R for the first time`下载安装包即可；注意可以将两个文件放在同一个文件夹内  
[参考](https://blog.csdn.net/m0_49354332/article/details/116059239)  


### 2.10 Rstudio
进入网站：`https://www.rstudio.com/products/rstudio/download/`  
R studio 可以在 Windows 下安装;
选择版本下载,下载完成之后双击安装。  
`
Windows 10/11	   
RStudio-2022.07.1-554.exe
`
### 2.11 parallel  
```
brew install parallel
```
### StringTie[可选]  
安装：  #师兄的安装方式是MAC，改成Linux
```
cd /mnt/d/biosoft

wget http://ccb.jhu.edu/software/stringtie/dl/stringtie-2.2.1.Linux_x86_64.tar.gz

tar -xzvf stringtie-2.2.1.Linux_x86_64.tar.gz
mv stringtie-2.2.1.Linux_x86_64 stringtie-2.2.1
cd stringtie-2.2.1

export PATH="$(pwd):$PATH"

stringtie --help
```

### Ballgown[可选]
不知道在哪里安装
```
source("http://bioconductor.org/biocLite.R")
biocLite("Ballgown")
```
# 数据下载  

1. [Ensemble网址](https://asia.ensembl.org/)  
在左侧`All genomes`中，选择物种`Rat`; 在左侧`Download DNA sequence (FASTA)` 下载基因组序列数据; 在右侧的`Download GTF or GFF3 (files for genes, cDNAs, ncRNA, proteins)`下载基因注释文件     
![P1](../RNA-seq/pictures/P1.png) 


2. ensemble中[数据集命名方式](http://ftp.ensembl.org/pub/release-107/fasta/rattus_norvegicus/dna/README)  

* 这些文件始终按照以下模式命名：
```
   <species>.<assembly>.<sequence type>.<id type>.<id>.fa.gz
例：
    Rattus_norvegicus.mRatBN7.2.dna.nonchromosomal.fa.gz  
    Rattus_norvegicus.mRatBN7.2.dna.primary_assembly.1.fa.gz
    Rattus_norvegicus.mRatBN7.2.dna_sm.toplevel.fa.gz


<species>：物种的系统名称。

<assembly>：程序集构建名称。

<sequence type>：
  * 'dna' - unmasked未屏蔽的基因组 DNA 序列。
  * 'dna_rm' - masked掩蔽的基因组 DNA。使用 RepeatMasker 工具检测散布的 重复和低复杂性区域，并通过用“N”替换重复来掩盖。
  * 'dna_sm' -  soft-masked软掩蔽基因组 DNA。所有重复和低复杂性区域都已替换为 其核酸碱基的小写版本

<id 类型> 以下之一：
  * 'chromosome' - Ensembl 中大多数物种的顶级坐标系top-level coordinate system
  * 'nonchromosomal' - 包含尚未分配到染色体的 DNA
  * 'seqlevel' - 这通常是sequence scaffolds、块chunks或克隆clones。
     -- 'scaffold' - 短的测序reads（通常来自whole genome shotgun, WGS）组装成较大的序列contigs，但尚未组装成染色体。需要更多的基因组测序来缩小gaps并建立 a tiling path。
     -- 'chunk' - 虽然 contig 序列可以组装成更大区块，有时必须人为地将它们分解为更小的块，称为'chunks'。这是由于注释中的限制pipeline 和 MySQL 有限的记录大小，用于存储序列和注释信息。
     -- 'clone' - 通常这是最小的序列单位。它通常与一个 BAC 克隆的序列或一个 BAC 克隆的序列区域相同，后者形成了tiling path.
<id>：实际的序列标识符。根据 <id type> <id>
          可以代表A chromosome, a scaffold, a contig, a clone的名称..
          seqlevel 文件的字段为空

fa：这些目录中的所有文件都代表FASTA数据库文件

gz：所有文件都使用 GNU Zip 压缩以提高存储效率。
```
* TOPLEVEL    

这些文件包含了 在 Ensembl 模式中标记为toplevel的所有序列区域。 这包括染色体chromsomes、未组装成染色体not assembled into chromosomes的区域和 N 填充的单倍型haplotype/补丁patch区域。

* PRIMARY ASSEMBLY  

初级组装包含所有toplevel序列区域，不包括单倍型和补丁。  
该文件最适合用于`序列相似性搜索`，因为其中补丁和单倍型序列会混淆分析。 如果primary assembly文件不存在，则表明没有单倍型/补丁区域，此时与“toplevel”文件相同。

* special 注意  
一些染色体是单倍体，例如人类的X和Y染色体  
为了比对时能正确输出报告，这些单倍体的assembly和patch区域都会补上同等数量的N   
例如： A patch region with a start position of 1,000,001 will have 1e6 N's added，因这样对齐程序将报告相对于
整个染色体。

人类已对 Y 染色体进行了测序，并对 Y 上的伪常染色体区域pseudoautosomal region (PAR) 进行了注释。 根据定义，PAR 区域在 X 和 Y 染色体上是相同的。 Y染色体文件包含Y染色体减去这些重复的 PAR 区域，即 Y 的唯一部分。  


3. 下载代码：  
目前大鼠的基因组测序版本到了7.2  
可以直接在网页下载，也可用代码  
```
# 下载
cd /mnt/d/project/rat/genome
wget http://ftp.ensembl.org/pub/release-107/fasta/rattus_norvegicus/dna/Rattus_norvegicus.mRatBN7.2.dna.toplevel.fa.gz
gzip -d Rattus_norvegicus.mRatBN7.2.dna.toplevel.fa.gz

# 改名（方便后面使用，名字太长一来不方便输入，二来可能会输错）
mv Rattus_norvegicus.mRatBN7.2.dna.toplevel.fa mRatBN7.2.fa

```
