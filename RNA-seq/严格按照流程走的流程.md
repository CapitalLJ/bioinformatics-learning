 # 目录  

 * [RNA-seq分析](#rna-seq分析)
      * [3. 数据下载](#3-数据下载)
         * [3.1 参考数据](#31-参考数据)
            * [Ensembl](#ensembl)
         * [3.2 测试数据（实验数据）](#32-测试数据实验数据)
      * [4. 质量控制](#4-质量控制)
         * [4.1 质量评估](#41-质量评估)
         * [4.2 剔除接头以及测序质量差的碱基](#42-剔除接头以及测序质量差的碱基)
         * [4.4 再次去除低质量区域](#44-再次去除低质量区域)
         * [4.3 再次查看质量情况](#43-再次查看质量情况)
      * [5. 去除rRNA序列](#5-去除rrna序列)
      * [6. 序列比对](#6-序列比对)
         * [6.1 建立索引](#6.1建立索引)
         * [6.2-开始比对](#6.2-开始比对)
      * [7. 表达量统计](#7-表达量统计)
      * [8. 合并表达矩阵与标准化](#8-合并表达矩阵与标准化)
         * [8.1 合并](#81-合并)
         * [8.2 数据标准化](#82-数据标准化)
            * [8.2.1 简介](#821-简介)
         * [8.2.2 cufflinks](#822-cufflinks)
         * [8.2.3 手动计算](#823-手动计算)
      * [9. 差异表达分析](#9-差异表达分析)
         * [9.1 数据前处理](#91-数据前处理)
         * [9.2 差异分析](#92-差异分析)
            * [9.2.1 安装与加载包](#921-安装与加载包)
            * [9.2.2 构建对象](#922-构建对象)
            * [9.2.3 样本相关性](#923-样本相关性)
            * [9.2.4 差异基因](#924-差异基因)
      * [10. 提取差异表达基因与注释](#10-提取差异表达基因与注释)
         * [10.1 名词解释](#101-名词解释)
         * [10.2 使用ClusterProfiler对基因的ID进行转化](#102-使用clusterprofiler对基因的id进行转化)
         * [10.3 使用biomaRt进行注释](#103-使用biomart进行注释)
      * [11. 可视化](#11-可视化)
      * [12. 富集分析](#12-富集分析)
         * [12.1 Gene Ontology (GO)分析](#121-gene-ontology-go分析)
         * [12.2 KEGG分析](#122-kegg分析)
         * [12.3 GSEA分析](#123-gsea分析)
         * [12.4 DO（Disease Ontology）分析](#124-dodisease-ontology分析)
         * [12.4 另外可以使用几个在线网站](#124-另外可以使用几个在线网站)
      * [========================================](#-1)
      * [5. 表达量分析](#5-表达量分析)
      * [6. 表达量分析](#6-表达量分析)
      * [7. 差异表达分析](#7-差异表达分析)
      * [作者](#作者)
      * [参考](#参考)
         * [流程](#流程)
         * [结果解读](#结果解读)
         * [原理](#原理)
         * [程序下载安装](#程序下载安装)
         * [问题](#问题)  

## 前期准备  

新建好合适目录：  
```
$ cd /mnt/d/project/rat6.0
$ mkdir annotation genome sequence output script

$ tree
.
├── annotation
├── genome
├── output
├── script
└── sequence

5 directories, 0 files
```

## 3. 数据下载  

### 3.1 参考数据
1. 下载基因组数据  

[Ensemble网址](https://asia.ensembl.org/)  

在左侧`All genomes`中，选择物种`Rat`; 在左侧`Download DNA sequence (FASTA)` 下载基因组序列数据，选择6.0版本; 在右侧的`Download GTF or GFF3 (files for genes, cDNAs, ncRNA, proteins)`下载基因注释文件   

* 下载、解压并查看，得到原始.fa的基因组数据

```
# 下载  
$ cd /mnt/d/project/rat6.0/genome
$ wget http://ftp.ensembl.org/pub/release-104/fasta/rattus_norvegicus/dna/Rattus_norvegicus.Rnor_6.0.dna.toplevel.fa.gz
# 注意：即使是下载原来的版本，网页地址也发生了改变

# 下载得到一个GZ文件， 解压为 .fa文件
$ gzip -d Rattus_norvegicus.Rnor_6.0.dna.toplevel.fa.gz


# 为方便后续操作，改名为rn6
$ mv   Rattus_norvegicus.Rnor_6.0.dna.toplevel.fa   rn6.fa

# 得到基因组文件，查看一下内容：
$ cat rn6.fa | grep "^>"    
# 只显示染色体的第一行的描述基因，.fa文件应该是第一行描述信息+具体测序结果 


# 结果： 
。。。
>18 dna:chromosome chromosome:Rnor_6.0:18:1:88201929:1 REF
>19 dna:chromosome chromosome:Rnor_6.0:19:1:62275575:1 REF
>20 dna:chromosome chromosome:Rnor_6.0:20:1:56205956:1 REF
>X dna:chromosome chromosome:Rnor_6.0:X:1:159970021:1 REF
>Y dna:chromosome chromosome:Rnor_6.0:Y:1:3310458:1 REF
>MT dna:chromosome chromosome:Rnor_6.0:MT:1:16313:1 REF
>KL568162.1 dna:scaffold scaffold:Rnor_6.0:KL568162.1:1:10937627:1 REF
>KL568139.1 dna:scaffold scaffold:Rnor_6.0:KL568139.1:1:9752924:1 REF
>KL568161.1 dna:scaffold scaffold:Rnor_6.0:KL568161.1:1:7627431:1 REF
。。。

```
* 整理  
```
# 去掉第一行的描述信息，只保留染色体编号和具体测序结果

$ mv rn6.fa rn6.raw.fa    # 首先将之前的名称更改一下

$ cat rn6.raw.fa | perl -n -e 'if(m/^>(.+?)(?:\s|$)/){ print ">$1\n";}else{print}' > rn6.fa    # 然后去除染色体编号后的描述信息

$ rm rn6.raw.fa   # 删除，可选
```  

* 统计染色体长度  
可以直接在第一行描述信息中统计，也可以直接计算后面跟的具体测序数目  
```
cat rn6.fa | perl -n -e '    # perl语言，回头记得看
    s/\r?\n//;
    if(m/^>(.+?)\s*$/){
        $title = $1;   
        push @t, $title;  
         # 如果染色体标号是数字则输出数字
    }elsif(defined $title){
        # 如果是其他字符则输出其他字符
        $title_len{$title} += length($_);
    }
    END{
        for my $title (@t){
            print "$title","\t","$title_len{$title}","\n";
        }
    }
'

# 结果
19      62275575
20      56205956
X       159970021
Y       3310458
MT      16313
KL568162.1      10937627
KL568139.1      9752924
KL568161.1      7627431
KL568148.1      6483517
```  

* 单独拿出来一号染色体做后续处理  

```
$ cat rn6.fa | perl -n -e '
  if(m/^>/){
    if(m/>1$/){
      $title = 1;
    }else{
      $title = 0;
    }
  }else{
    push @s, $_ if $title;
  }
  END{
    printf ">1\n%s", join("", @s);
  }
' > rn6.chr1.fa
```

2. 下载注释信息  

* 下载gff信息
```
$ cd /mnt/d/project/rat6.0/annotation
$ wget http://ftp.ensembl.org/pub/release-104/gff3/rattus_norvegicus/Rattus_norvegicus.Rnor_6.0.104.gff3.gz
$ gzip -d Rattus_norvegicus.Rnor_6.0.104.gff3.gz

# 同样的也改名
$ mv Rattus_norvegicus.Rnor_6.0.104.gff3 rn6.gff

# 使用head查看部分
$ head rn6.gff

# 结果:   和流程里面可能不太对
##gff-version 3
##sequence-region   1 1 282763074
##sequence-region   10 1 112626471
##sequence-region   11 1 90463843
##sequence-region   12 1 52716770
##sequence-region   13 1 114033958
##sequence-region   14 1 115493446
##sequence-region   15 1 111246239
##sequence-region   16 1 90668790
##sequence-region   17 1 90843779

# 直接cat rn6.gff
X       ensembl exon    157152216       157152290       .       +       .       Parent=transcript:ENSRNOT00000090795;Name=ENSRNOE00000522621;constitutive=1;ensembl_end_phase=2;ensembl_phase=2;exon_id=ENSRNOE00000522621;rank=4;version=1
X       ensembl CDS     157152216       157152290       .       +       1       ID=CDS:ENSRNOP00000074179;Parent=transcript:ENSRNOT00000090795;protein_id=ENSRNOP00000074179

# 查找师兄举例的基因，发现可以找到，文件应该没有问题
xuruizhi@DESKTOP-HI65AUV:/mnt/d/project/rat6.0/annotation$ cat rn6.gff | grep "ENSRNOG00000046319"
1       ensembl_havana  ncRNA_gene      396700  409750  .       +       .       ID=gene:ENSRNOG00000046319;Name=AABR07000046.1;biotype=processed_transcript;gene_id=ENSRNOG00000046319;logic_name=ensembl_havana_gene;version=4
1       ensembl lnc_RNA 396700  409676  .       +       .       ID=transcript:ENSRNOT00000044187;Parent=gene:ENSRNOG00000046319;Name=AABR07000046.1-202;biotype=processed_transcript;transcript_id=ENSRNOT00000044187;version=4
```

* 下载gtf信息
```
$ cd /mnt/d/project/rat6.0/annotation
$ wget http://ftp.ensembl.org/pub/release-104/gtf/rattus_norvegicus/Rattus_norvegicus.Rnor_6.0.104.gtf.gz
$ gzip -d Rattus_norvegicus.Rnor_6.0.104.gtf.gz

# 同样的也改名
$ mv Rattus_norvegicus.Rnor_6.0.104.gtf rn6.gtf

# 使用head查看部分
$ head rn6.gtf

# 结果: 
#!genome-build Rnor_6.0
#!genome-version Rnor_6.0
#!genome-date 2014-07
#!genome-build-accession GCA_000001895.4
#!genebuild-last-updated 2017-01
1       havana  gene    261992430       261993135       .       -       .       gene_id "ENSRNOG00000054910"; gene_version "1"; gene_name "AC096317.3"; gene_source "havana"; gene_biotype "sense_intronic";
1       havana  transcript      261992430       261993135       .       -       .       gene_id "ENSRNOG00000054910"; gene_version "1"; transcript_id "ENSRNOT00000079974"; transcript_version "1"; gene_name "AC096317.3"; gene_source "havana"; gene_biotype "sense_intronic"; transcript_name "AC096317.3-201"; transcript_source "havana"; transcript_biotype "sense_intronic";
```

## 3.2 测试数据（实验数据）  
1. 下载RNA测序数据  

* 从NCBI上查找相关的RNA-seq数据进行下载，在[GEO数据库](http://www.ncbi.nlm.nih.gov/geo) 中找了一个数据`GSE72960`，对应的`SRP`数据为`SRP063345`   

* 点击最下面的`SRA Run selector`下载测序数据, 在Accession中搜索SRA号(SRPxxx，	SRP063345)，里面包含了所有测序样本的测序信息以及文件SRR编号（例如，SRR2190795）  

* 将刚才在`Run selector`中查找到的数据的编号复制下来，之后下载测序数据，下载脚本如下，这里是采用`SRAtoolkit`工具包中的`prefetch`工具，如果部分数据下载失败，那么再次执行下面的代码    

```
cd /mnt/d/project/rat6.0/sequence

nohup prefetch SRR2190795 SRR224018{2..7} SRR2240228 -o . &
```

上面代码下载容易出错 
采用下面↓代码进行下载  

```
# 先把需要下载的文件名称写入一个单独的txt文件中
# 不可像SRR224018{2..7}这样省略，要不然找不到数据

xuruizhi@DESKTOP-HI65AUV:/mnt/d/project/rat6.0/sequence$  cat >1.txt <<EOF
> SRR2190795
> SRR2240182
> SRR2240183
> SRR2240184
> SRR2240185
> SRR2240186
> SRR2240187
> SRR2240228
> EOF

# 执行下列代码下载数据,下载到 /mnt/d/project/rat6.0/sequence 文件夹内  
[onhup]  prefetch --option-file 1.txt

注： 原来已经下载到了~/data/sra文件夹内，所以没有办法再下载  
```

2. 更改.sra 为 fastq 格式  

```
xuruizhi@DESKTOP-HI65AUV:~/data/sra$ ls
SRR2190795.sra  SRR2240183.sra  SRR2240185.sra  SRR2240187.sra
SRR2240182.sra  SRR2240184.sra  SRR2240186.sra  SRR2240228.sra


xuruizhi@DESKTOP-HI65AUV:~/data/sra$ 
parallel -j 4 "    # 用parallel多线程加快速度，并行任务数为4  
    fastq-dump --outdir /mnt/d/project/rat6.0/sequence --gzip {1}    
    # 将sra文件转化为fastq文件之后压缩为gz文件

" ::: $(ls *.sra)     # :::后接对象

# ls *.sra代表，列举出任何以.sra结尾的文件
--gzip 将转换出的fastq文件以gz格式输出，可以节省空间
--split-3 把pair-end测序分成两个文件输出，可用于双端测序转化为两个文件，本文举例为单端测序，删掉不影响
-O 输出文件夹名，不加直接放在该文件夹

# 删除sra文件
$ rm *.sra
```
* 查看下载好的gz文件  
```
   cd ~/data/sra/mnt/d/project/rat6.0/sequence
   gzip -d -c SRR2190795.fastq.gz | head -n 20
或者
   zless -S SRR2190795.fastq.gz


# gzip
-c或--stdout或--to-stdout 　把压缩后的文件输出到标准输出设备，不去更动原始文件。
-d或--decompress或----uncompress 　解开压缩文件。

结果：
@SRR2190795.1 HWI-ST1147:240:C5NY7ACXX:1:1101:1320:2244 length=100
ATGCTGGGGGCATTAGCATTGGGTACTGAATTATTTTCAGTAAGAGGGAAAGAATCCATCTCCNNNNNNNNNNNNNNNNNNNNNNAAANAAAAATAAAAT
+SRR2190795.1 HWI-ST1147:240:C5NY7ACXX:1:1101:1320:2244 length=100
CCCFFFFFHHHHHJIJJJJJJJJDHHJJJIJJJJJIJJJJJJJJJJJJJJJJJJJJJJJJJHH#####################################
@SRR2190795.2 HWI-ST1147:240:C5NY7ACXX:1:1101:1598:2247 length=100
AACTTCGGTTCTCTACTAGGAGTATGCCTCATAGTACAAATCCTCACAGGCTTATTCCTAGCANNNNNNNNNNNNNNNNNNNNNNTAACAGCATTTTCAT
+SRR2190795.2 HWI-ST1147:240:C5NY7ACXX:1:1101:1598:2247 length=100
@@@7D8+@A:1CFG<C:23<:E<;FF<BHIIEHG:?:??CDF<9DCGGG?1?FEG@@<@CA#######################################
```

##  4. 质量控制
### 4.1 用 fastqc 进行质量评估  
* 对测序结果fastqc  

```
# 新建目录  
mkdir /mnt/d/project/rat6.0/output/fastqc

！注意！一定在存储fastqc.gz的文件夹路径下执行下面的命令

xuruizhi@DESKTOP-HI65AUV:~$ cd /mnt/d/project/rat6.0/sequence
fastqc -t 6 -o /mnt/d/project/rat6.0/output/fastqc *.gz
# -t 指定线程数
# -o 指定输出文件夹
# *.gz 表示这个目录下以 .gz 的所有文件
```
* 用multiqc 进行整合  
```
$ cd /mnt/d/project/rat6.0/output/fastqc

$ multiqc .
```

### 4.2 剔除接头以及测序质量差的碱基  
采用`cutadapt`进行两端低质量的区域的去除  

```

# 新建文件夹
$ mkdir -p /mnt/d/project/rat6.0/output/adapter/
xuruizhi@DESKTOP-HI65AUV:/mnt/d/project/rat6.0/output$ mkdir adapter
xuruizhi@DESKTOP-HI65AUV:/mnt/d/project/rat6.0/output$ ls
adapter  fastqc

# 挂载到测序数据存储文件夹内
cd /mnt/d/project/rat6.0/sequence

xuruizhi@DESKTOP-HI65AUV:/mnt/d/project/rat6.0/sequence$ ls
SRR2190795.fastq.gz  SRR2240183.fastq.gz  SRR2240185.fastq.gz  SRR2240187.fastq.gz
SRR2240182.fastq.gz  SRR2240184.fastq.gz  SRR2240186.fastq.gz  SRR2240228.fastq.gz


# 循环处理文件夹下的数据
for i in $(ls *.fastq.gz);
do
    cutadapt -a AATGATACGGCGACCACCGAGATCTACACTCTTTCCCTACACGACGCTCTTCCGATCT \
    --minimum-length 30 --overlap 4 --trim-n \
    -o /mnt/d/project/rat6.0/output/adapter/${i}  ${i} 
    
    # --minimum-length 如果剔除接头后read长度低于30，这条read将会被丢弃
    # --overlap        如果两端的序列与接头有4个碱基的匹配将会被剔除
    # --trim-n         剔除两端的N
    # -a 去除3端引物序列

done
```

### 4.3 再次去除低质量区域  

```
$ cd /mnt/d/project/rat6.0/output/adapter
$ mkdir ../trim

$ parallel -j 4 "
 
  # Trimmomatic-0.38我下载到了别的盘内，记得更改路径
  java -jar /mnt/d/biosoft/Trimmomatic-0.38/Trimmomatic-0.38.jar \
    SE -phred33 {1} /mnt/d/project/rat6.0/output/trim/{1} \
    LEADING:20 TRAILING:20 SLIDINGWINDOW:5:15 MINLEN:30 \

  # LEADING:20，从序列的开头开始去掉质量值小于 20 的碱基
  # TRAILING:20，从序列的末尾开始去掉质量值小于 20 的碱基
  # SLIDINGWINDOW:5:15，从 5' 端开始以 5bp 的窗口计算碱基平均质量，如果此平均值低于 15，则从这个位置截断read
  # MINLEN:30， 如果 reads 长度小于 30bp 则扔掉整条 read。

" ::: $( ls *.gz)

# 本命令逻辑  
java -jar  [Trimmomatic软件存储位置]\
   [单端测序] SE -phred33 {变量名称}      [指明存储路径和名称] ../trim/{变量名称}\
   Trimmomatic软件的命令选项  
```


### 4.3 再次查看质量情况  
```
$ cd /mnt/d/project/rat6.0/output/trim

$ mkdir ../fastqc_trim
$ parallel -j 4 "
    fastqc -t 4 -o ../fastqc_trim {1}
" ::: $(ls *.gz)

$ cd ../fastqc_trim
$ multiqc .
```
 

